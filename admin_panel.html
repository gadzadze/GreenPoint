<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GreenPoint Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Roboto', sans-serif; margin: 0; padding: 0; background-color: #f5f5f5; color: #333; display: flex; }
        .sidebar { width: 250px; height: 100vh; background-color: #1a3c34; color: white; position: fixed; padding-top: 20px; transition: all 0.3s; z-index: 1001; }
        .sidebar a { padding: 15px 20px; text-decoration: none; color: white; display: flex; align-items: center; font-size: 16px; transition: all 0.3s; }
        .sidebar a i { margin-right: 10px; }
        .sidebar a.active { background-color: #2e5a50; border-left: 4px solid #fff; }
        .sidebar a:hover { background-color: #2e5a50; }
        .content { margin-left: 250px; padding: 20px; width: calc(100% - 250px); transition: margin-left 0.3s, width 0.3s; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background-color: #fff; border-bottom: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header h2 { margin: 0; font-size: 24px; }
        .user-profile { display: flex; align-items: center; }
        .user-profile img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-top: 20px; }
        .card { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; transition: transform 0.2s, box-shadow 0.2s; cursor: pointer;}
        .card:hover { transform: translateY(-5px); box-shadow: 0 6px 10px rgba(0,0,0,0.15); }
        .card i { font-size: 24px; margin-bottom: 10px; color: #1a3c34; }
        .chart-container, .table-container, .calendar-container, .form-container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 20px; }
        canvas { max-height: 300px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f0f0f0; font-weight: 500; color: #555; }
        tr:hover { background-color: #f9f9f9; } /* Hover effect for table rows */

        .status-pending { background-color: #ffeb3b; padding: 5px 10px; border-radius: 12px; display: inline-block; font-size: 0.85em; color: #333; }
        .status-in-stock { background-color: #d4edda; color: #155724; padding: 5px 10px; border-radius: 12px; display: inline-block; font-size: 0.85em; }
        .status-low-stock { background-color: #ffeeba; color: #856404; padding: 5px 10px; border-radius: 12px; display: inline-block; font-size: 0.85em; }
        .status-completed { background-color: #d4edda; color: #155724; padding: 5px 10px; border-radius: 12px; display: inline-block; font-size: 0.85em; }
        .status-cancelled { background-color: #f8d7da; color: #721c24; padding: 5px 10px; border-radius: 12px; display: inline-block; font-size: 0.85em; }
        
        .calendar-month table { width: 100%; border-collapse: collapse; }
        .calendar-month th, .calendar-month td { padding: 10px; text-align: center; border: 1px solid #ddd; }
        .calendar-month .current-day { background-color: #2e5a50; color: white; border-radius: 50%; width: 30px; height: 30px; line-height: 30px; display: inline-block; }
        .calendar-month .has-booking { background-color: #e0f7fa; font-weight: bold; }
        .calendar-month td:hover { background-color: #f0f0f0; cursor: pointer; }

        .predictive-insights { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px; }
        .insight-card { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; }
        
        button { background-color: #1a3c34; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; transition: background-color 0.3s, transform 0.2s; font-weight: 500; }
        button:hover { background-color: #2e5a50; transform: translateY(-1px); }
        button:active { transform: translateY(0); }
        
        .add-button { float: right; margin-bottom: 15px; } /* Added margin for better spacing */
        .add-button:hover { background-color: #2e5a50; }
        
        .search-bar { padding: 10px; width: calc(100% - 22px); margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; } /* Box-sizing for consistent width */
        .tabs { margin-bottom: 15px; display: flex; border-bottom: 2px solid #eee; }
        .tab { padding: 10px 20px; border: none; background-color: #f5f5f5; cursor: pointer; margin-right: 5px; border-radius: 5px 5px 0 0; transition: background-color 0.3s, color 0.3s; }
        .tab.active { background-color: #1a3c34; color: white; }
        .tab:hover:not(.active) { background-color: #e0e0e0; }

        .notification { position: fixed; top: 20px; right: 20px; background-color: #4caf50; color: white; padding: 10px 20px; border-radius: 5px; display: none; z-index: 10000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        
        .form-container input[type="text"],
        .form-container input[type="number"],
        .form-container input[type="email"],
        .form-container input[type="tel"],
        .form-container input[type="date"],
        .form-container select {
            width: 100%; /* Changed to 100% */
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box; /* Crucial for consistent width */
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .form-container input[type="text"]:focus,
        .form-container input[type="number"]:focus,
        .form-container input[type="email"]:focus,
        .form-container input[type="tel"]:focus,
        .form-container input[type="date"]:focus,
        .form-container select:focus {
            border-color: #2e5a50;
            box-shadow: 0 0 5px rgba(46, 90, 80, 0.3);
            outline: none;
        }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: #555; }
        .form-group input[type="checkbox"] { width: auto; margin-right: 10px; accent-color: #1a3c34; }
        .photo-preview { margin-top: 15px; text-align: center; }
        .photo-preview img { max-width: 200px; height: auto; border-radius: 8px; border: 1px solid #eee; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        .action-icons { display: flex; gap: 12px; justify-content: flex-start; } /* Added gap for spacing icons */
        .action-icons i { cursor: pointer; color: #555; transition: color 0.2s, transform 0.2s; }
        .action-icons i:hover { color: #1a3c34; transform: scale(1.1); }
        .action-icons i.fa-trash:hover { color: #f44336; } /* Red for delete */
        .action-icons i.fa-check-circle:hover { color: #4caf50; } /* Green for complete */
        .action-icons i.fa-plus-circle:hover, .action-icons i.fa-tag:hover { color: #2196f3; } /* Blue for add/restock */

        /* GreenPoints specific styles */
        .greenpoints-card {
            background-color: #1a3c34; /* Dark green background */
            color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
            margin-bottom: 20px;
        }
        .greenpoints-card h3 {
            margin-top: 0;
            font-size: 28px;
            margin-bottom: 10px;
        }
        .greenpoints-card p {
            font-size: 48px;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .greenpoints-card p i {
            font-size: 48px;
            margin-right: 15px;
            color: #f4a261; /* Accent color for the icon */
        }
        .greenpoints-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .greenpoints-actions button {
            width: 100%;
            background-color: #2e5a50;
            border-radius: 8px;
            padding: 15px;
            font-size: 18px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .greenpoints-actions button:hover {
            background-color: #3d7d70;
        }
        .greenpoints-history table {
            margin-top: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden; /* Ensures border-radius applies to table */
        }
        .greenpoints-history th {
            background-color: #1a3c34;
            color: white;
        }
        .greenpoints-history td {
            font-size: 0.9em;
        }
        .greenpoints-history .points-earned {
            color: #4caf50;
            font-weight: bold;
        }
        .greenpoints-history .points-spent {
            color: #f44336;
            font-weight: bold;
        }
        .greenpoints-history .points-bonus {
            color: #2196f3;
            font-weight: bold;
        }
        .greenpoints-badge {
            background-color: #f4a261;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            margin-left: 10px;
        }

        /* Responsive adjustments */
        @media (max-width: 992px) {
            .dashboard-grid, .predictive-insights {
                grid-template-columns: repeat(2, 1fr); /* 2 columns on medium screens */
            }
            .greenpoints-actions {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-250px);
                width: 220px; /* Slightly smaller sidebar on mobile */
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .content {
                margin-left: 0;
                width: 100%;
                padding: 15px;
            }
            .header {
                padding: 10px 15px;
            }
            .header h2 {
                font-size: 20px;
            }
            .dashboard-grid, .predictive-insights {
                grid-template-columns: 1fr; /* Single column on small screens */
            }
            .menu-toggle {
                display: block; /* Show menu toggle button */
                margin-right: 15px;
                background: none;
                border: none;
                color: #333;
                font-size: 24px;
                cursor: pointer;
            }
            .header .user-profile {
                display: none; /* Hide user profile on small screens */
            }
            .greenpoints-card p {
                font-size: 38px; /* Adjust for smaller screens */
            }
            .greenpoints-card p i {
                font-size: 38px;
            }
        }

        /* Menu toggle button (initially hidden on large screens) */
        .menu-toggle {
            display: none;
        }

        /* Ensure sidebar is not hidden on larger screens by default */
        @media (min-width: 769px) {
            .sidebar {
                transform: translateX(0);
            }
            .content {
                margin-left: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar" id="sidebar">
        <a href="#" class="active" onclick="showPage('dashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
        <a href="#" onclick="showPage('bookings')"><i class="fas fa-calendar-check"></i> Bookings</a>
        <a href="#" onclick="showPage('analytics')"><i class="fas fa-chart-line"></i> Analytics</a>
        <a href="#" onclick="showPage('inventory')"><i class="fas fa-warehouse"></i> Inventory</a>
        <a href="#" onclick="showPage('customers')"><i class="fas fa-users"></i> Customers</a>
        <a href="#" onclick="showPage('calendar')"><i class="fas fa-calendar"></i> Calendar View</a>
        <a href="#" onclick="showPage('greenpoints')"><i class="fas fa-coins"></i> GreenPoints</a> <a href="#" onclick="showPage('settings')"><i class="fas fa-cog"></i> Settings</a>
        <a href="#" onclick="auth.logout()" style="position: absolute; bottom: 20px; width: 90%;"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </div>
    <div class="content" id="content">
        <div class="header">
            <button class="menu-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
            <h2 id="page-title">Dashboard</h2>
            <div class="user-profile">
                <img src="https://via.placeholder.com/40" alt="User Profile">
                <span>Admin</span>
            </div>
        </div>

        <div id="dashboard" class="page">
            <div class="dashboard-grid">
                <div class="card">
                    <i class="fas fa-calendar-day"></i>
                    <h3>Total Bookings</h3>
                    <p id="totalBookings">0</p>
                </div>
                <div class="card">
                    <i class="fas fa-check-circle"></i>
                    <h3>Completed Services</h3>
                    <p id="completedServices">0</p>
                </div>
                <div class="card">
                    <i class="fas fa-clock"></i>
                    <h3>Pending Services</h3>
                    <p id="pendingServices">0</p>
                </div>
                <div class="card">
                    <i class="fas fa-exclamation-circle"></i>
                    <h3>Low Stock Items</h3>
                    <p id="lowStockItems">0</p>
                </div>
            </div>
            <div class="chart-container">
                <h3>Bookings Overview</h3>
                <p>Monthly booking trends for the last 6 months.</p>
                <canvas id="bookingsChart"></canvas>
            </div>
            <div class="table-container">
                <h3>Quick Inventory Status</h3>
                <input type="text" class="search-bar" placeholder="Search inventory by item name..." onkeyup="searchInventory()">
                <table id="inventoryTable">
                    <tr><th>Item Name</th><th>Quantity</th><th>Status</th></tr>
                </table>
            </div>
        </div>

        <div id="bookings" class="page" style="display: none;">
            <div class="header">
                <h2>Manage Bookings</h2>
                <button class="add-button" onclick="showAddBookingForm()">Add Booking</button>
            </div>
            <div class="table-container">
                <input type="text" class="search-bar" placeholder="Search bookings (name, service, model, VIN)..." onkeyup="searchBookings()">
                <div class="tabs">
                    <button class="tab active" onclick="filterBookings('all')">All</button>
                    <button class="tab" onclick="filterBookings('pending')">Pending</button>
                    <button class="tab" onclick="filterBookings('completed')">Completed</button>
                    <button class="tab" onclick="filterBookings('cancelled')">Cancelled</button>
                </div>
                <table id="bookingsTable">
                    <tr><th>ID</th><th>Customer</th><th>Service</th><th>Vehicle</th><th>VIN</th><th>Date</th><th>Status</th><th>Actions</th></tr>
                </table>
            </div>
            <div id="addBookingForm" class="form-container" style="display: none;">
                <h3>Add New Booking</h3>
                <form id="bookingForm">
                    <div class="form-group"><label for="bookingCustomerName">Customer Name</label><input type="text" id="bookingCustomerName" name="customerName" placeholder="Customer Name" required></div>
                    <div class="form-group"><label for="bookingService">Service</label><input type="text" id="bookingService" name="service" placeholder="Service" required></div>
                    <div class="form-group"><label for="bookingVehicle">Vehicle</label><input type="text" id="bookingVehicle" name="vehicle" placeholder="Vehicle" required></div>
                    <div class="form-group"><label for="bookingVIN">VIN</label><input type="text" id="bookingVIN" name="vin" placeholder="VIN" required></div>
                    <div class="form-group"><label for="bookingDate">Date</label><input type="date" id="bookingDate" name="date" required></div>
                    <button type="submit">Submit</button>
                    <button type="button" onclick="hideAddBookingForm()" style="background-color: #777; margin-left: 10px;">Cancel</button>
                </form>
            </div>
        </div>

        <div id="analytics" class="page" style="display: none;">
            <div class="header"><h2>Performance Analytics</h2></div>
            <div class="chart-container"><h3>Monthly Bookings</h3><p>Number of bookings per month.</p><canvas id="monthlyBookingsChart"></canvas></div>
            <div class="chart-container"><h3>Monthly Revenue</h3><p>Total revenue generated per month.</p><canvas id="monthlyRevenueChart"></canvas></div>
            <div class="chart-container"><h3>Popular Services</h3><p>Distribution of service types.</p><canvas id="popularServicesChart"></canvas></div>
            <div class="predictive-insights">
                <div class="insight-card"><i class="fas fa-chart-line"></i><h3>Predict Future Demand</h3><p>Analyze historical data.</p><button onclick="predictDemand()">Generate Forecast</button></div>
                <div class="insight-card"><i class="fas fa-calendar-check"></i><h3>Optimize Scheduling</h3><p>Generate efficient schedule.</p><button onclick="optimizeSchedule()">Optimize</button></div>
                <div class="insight-card"><i class="fas fa-exclamation-triangle"></i><h3>Identify Shortages</h3><p>Find potential shortages.</p><button onclick="identifyShortages()">Identify</button></div>
            </div>
        </div>

        <div id="inventory" class="page" style="display: none;">
            <div class="header">
                <h2>Inventory Management</h2>
                <button class="add-button" onclick="showAddInventoryForm()">Add Item</button>
            </div>
            <div class="table-container">
                <input type="text" class="search-bar" placeholder="Search inventory by item name..." onkeyup="searchInventory()">
                <table id="inventoryTable">
                    <tr><th>ID</th><th>Item Name</th><th>Quantity</th><th>Status</th><th>Actions</th></tr>
                </table>
            </div>
            <div id="addInventoryForm" class="form-container" style="display: none;">
                <h3>Add New Inventory Item</h3>
                <form id="inventoryForm">
                    <div class="form-group"><label for="inventoryItemName">Item Name</label><input type="text" id="inventoryItemName" name="itemName" placeholder="Item Name" required></div>
                    <div class="form-group"><label for="inventoryQuantity">Quantity</label><input type="number" id="inventoryQuantity" name="quantity" placeholder="Quantity" required min="0"></div>
                    <button type="submit">Submit</button>
                    <button type="button" onclick="hideAddInventoryForm()" style="background-color: #777; margin-left: 10px;">Cancel</button>
                </form>
            </div>
        </div>

        <div id="customers" class="page" style="display: none;">
            <div class="header">
                <h2>Customer Management</h2>
                <button class="add-button" onclick="showAddCustomerForm()">Add Customer</button>
            </div>
            <div class="table-container">
                <input type="text" class="search-bar" placeholder="Search customers by name or email..." onkeyup="searchCustomers()">
                <table id="customersTable">
                    <tr><th>ID</th><th>Name</th><th>Email</th><th>Phone</th><th>Tags</th><th>Actions</th></tr>
                </table>
            </div>
            <div id="addCustomerForm" class="form-container" style="display: none;">
                <h3>Add New Customer</h3>
                <form id="customerForm">
                    <div class="form-group"><label for="customerName">Name</label><input type="text" id="customerName" name="customerName" placeholder="Name" required></div>
                    <div class="form-group"><label for="customerEmail">Email</label><input type="email" id="customerEmail" name="customerEmail" placeholder="Email" required></div>
                    <div class="form-group"><label for="customerPhone">Phone</label><input type="tel" id="customerPhone" name="customerPhone" placeholder="Phone" required></div>
                    <div class="form-group"><label for="customerTags">Tags (comma-separated)</label><input type="text" id="customerTags" name="customerTags" placeholder="e.g., VIP, New, Fleet" required></div>
                    <button type="submit">Submit</button>
                    <button type="button" onclick="hideAddCustomerForm()" style="background-color: #777; margin-left: 10px;">Cancel</button>
                </form>
            </div>
        </div>

        <div id="calendar" class="page" style="display: none;">
            <div class="header"><h2>Service Calendar</h2></div>
            <div class="calendar-container calendar">
                <div class="calendar-month">
                    <h3>Service Schedule</h3>
                    <input type="month" id="calendarMonth" onchange="updateCalendar()">
                    <table id="calendarTable">
                        </table>
                </div>
                <div class="calendar-month" id="calendarBookings">
                    <h3>Bookings for Selected Day</h3>
                    <p>Select a day to see bookings.</p>
                </div>
            </div>
        </div>

        <div id="greenpoints" class="page" style="display: none;">
            <div class="header">
                <h2>Your GreenPoints</h2>
            </div>
            <div class="greenpoints-card">
                <h3>Current GreenPoints Balance</h3>
                <p><i class="fas fa-coins"></i> <span id="currentGreenPoints">0</span></p>
                <div class="greenpoints-badge">Service Partner</div>
            </div>

            <div class="chart-container"> <h3>Quick Actions</h3>
                <div class="greenpoints-actions">
                    <button onclick="admin.earnPoints(100, 'Completed Booking')">Earn 100 Points (Completed Booking)</button>
                    <button onclick="admin.earnPoints(250, 'High Rating Bonus')">Earn 250 Points (High Rating)</button>
                    <button onclick="admin.earnPoints(500, 'Referral Bonus')">Earn 500 Points (Referral)</button>
                    <button onclick="admin.spendPoints(200, 'Boost Visibility')">Spend 200 Points (Boost Visibility)</button>
                    <button onclick="admin.spendPoints(150, 'Discount on Features')">Spend 150 Points (Feature Discount)</button>
                </div>
            </div>
            
            <div class="table-container greenpoints-history">
                <h3>GreenPoints Transaction History</h3>
                <table id="greenPointsHistoryTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Points</th>
                            <th>Type</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>
        <div id="settings" class="page" style="display: none;">
            <div class="header"><h2>Service Center Details</h2></div>
            <div class="table-container form-container">
                <h3>General Information</h3>
                <div class="form-group"><label for="centerName">Center Name</label><input type="text" id="centerName" value="EV Central Hub"></div>
                <div class="form-group"><label for="contactEmail">Contact Email</label><input type="email" id="contactEmail" value="contact@evcentralhub.com"></div>
                <div class="form-group"><label for="contactPhone">Contact Phone</label><input type="tel" id="contactPhone" value="+1 (123) 456-7890"></div>
                <div class="form-group"><label for="address">Address</label><input type="text" id="address" value="123 EV Street, ElectriCity, CA 90210"></div>

                <h3 style="margin-top: 30px;">Operational Settings</h3>
                <div class="form-group"><label for="workingHours">Working Hours</label><input type="text" id="workingHours" value="Mon-Fri: 9:00 AM - 6:00 PM, Sat: 10:00 AM - 4:00 PM"></div>
                <div class="form-group"><label for="defaultServiceDuration">Default Service Duration (minutes)</label><input type="number" id="defaultServiceDuration" value="60" min="15"></div>
                <div class="form-group"><label for="taxRate">Tax Rate (%)</label><input type="number" id="taxRate" step="0.01" value="8.25" min="0"></div>
                <div class="form-group">
                    <label for="defaultCurrency">Default Currency</label>
                    <select id="defaultCurrency">
                        <option value="USD">USD ($)</option>
                        <option value="EUR">EUR (€)</option>
                        <option value="GBP">GBP (£)</option>
                        <option value="JPY">JPY (¥)</option>
                    </select>
                </div>

                <h3 style="margin-top: 30px;">Notification Preferences</h3>
                <div class="form-group">
                    <input type="checkbox" id="emailNotifications" checked><label for="emailNotifications">Enable Email Notifications</label>
                </div>
                <div class="form-group">
                    <input type="checkbox" id="smsNotifications"><label for="smsNotifications">Enable SMS Notifications</label>
                </div>

                <h3 style="margin-top: 30px;">Branding & Appearance</h3>
                <div class="form-group">
                    <label>Center Logo / Photos</label>
                    <input type="file" id="photoUpload" style="display: none;" onchange="previewPhoto()" accept="image/*"><button onclick="document.getElementById('photoUpload').click()">Upload Photos</button>
                    <div class="photo-preview">
                        <img id="logoPreview" src="https://via.placeholder.com/150x80?text=Center+Logo" alt="Center Logo Preview">
                    </div>
                </div>

                <h3 style="margin-top: 30px;">Service Management</h3>
                <button class="add-button" onclick="showAddServiceForm()">Add New Service</button>
                <div class="table-container">
                    <table id="servicesTable">
                        <tr><th>ID</th><th>Service Name</th><th>Price</th><th>Actions</th></tr>
                    </table>
                </div>
                <div id="addServiceForm" class="form-container" style="display: none;">
                    <h4>Add/Edit Service</h4>
                    <form id="serviceForm">
                        <div class="form-group"><label for="serviceName">Service Name</label><input type="text" id="serviceName" name="serviceName" placeholder="e.g., Battery Diagnostics" required></div>
                        <div class="form-group"><label for="servicePrice">Price</label><input type="number" id="servicePrice" name="servicePrice" placeholder="e.g., 99.99" step="0.01" required min="0"></div>
                        <button type="submit">Save Service</button>
                        <button type="button" onclick="hideAddServiceForm()" style="background-color: #777; margin-left: 10px;">Cancel</button>
                    </form>
                </div>
                
                <button onclick="saveSettings()">Save Changes</button>
                <button onclick="resetSettings()" style="background-color: #f44336; margin-left: 10px;">Reset to Defaults</button>
            </div>
        </div>

        <div class="notification" id="notification">Action completed!</div>
    </div>

    <script>
        // Dummy authentication object for local testing purposes
        const auth = {
            tokenKey: 'greenpoint_auth_token',
            roleKey: 'greenpoint_user_role',
            baseUrl: 'http://localhost:3000/api', // Replace with your actual API base URL
            logout: function() {
                localStorage.removeItem(this.tokenKey);
                localStorage.removeItem(this.roleKey);
                alert('Logged out. Redirecting to login page.');
                window.location.href = 'index.html'; // Redirect to your login page
            }
        };

        class AdminPanel {
            constructor() {
                this.bookingsData = [];
                this.inventoryData = [];
                this.customersData = [];
                this.servicesData = []; // New array for services
                this.greenPointsData = []; // NEW: Array for GreenPoints transactions
                this.currentDate = new Date(); // Set to current actual date

                // Default settings
                this.defaultSettings = {
                    centerName: "EV Central Hub",
                    contactEmail: "contact@evcentralhub.com",
                    contactPhone: "+1 (123) 456-7890",
                    address: "123 EV Street, ElectriCity, CA 90210",
                    workingHours: "Mon-Fri: 9:00 AM - 6:00 PM, Sat: 10:00 AM - 4:00 PM",
                    defaultServiceDuration: 60,
                    taxRate: 8.25,
                    defaultCurrency: "USD",
                    emailNotifications: true,
                    smsNotifications: false,
                    logoUrl: "https://via.placeholder.com/150x80?text=Center+Logo"
                };

                this.loadDataFromLocalStorage();
            }

            loadDataFromLocalStorage() {
                const storedBookings = localStorage.getItem('greenpoint_bookings');
                if (storedBookings) {
                    this.bookingsData = JSON.parse(storedBookings);
                } else {
                     // Initial dummy data if nothing in local storage
                    this.bookingsData = [
                        { id: 1, customer: "John Doe", service: "Battery Check", vehicle: "Tesla Model 3", vin: "5YJ3E1EA7F000001", date: "2025-05-30", status: "pending" },
                        { id: 2, customer: "Jane Smith", service: "Tire Rotation", vehicle: "Nissan Leaf", vin: "1N4AZ0CP5FC300002", date: "2025-06-05", status: "completed" },
                        { id: 3, customer: "Peter Jones", service: "Diagnostics", vehicle: "Chevy Bolt", vin: "GH4AZ0CP5FC300003", date: "2025-06-10", status: "pending" },
                        { id: 4, customer: "Alice Brown", service: "Brake Inspection", vehicle: "Ford Mustang Mach-E", vin: "LM7AZ0CP5FC300004", date: "2025-06-15", status: "pending" },
                        { id: 5, customer: "Robert White", service: "Software Update", vehicle: "Hyundai Kona Electric", vin: "OP9AZ0CP5FC300005", date: "2025-06-20", status: "cancelled" }
                    ];
                }

                const storedInventory = localStorage.getItem('greenpoint_inventory');
                if (storedInventory) {
                    this.inventoryData = JSON.parse(storedInventory);
                } else {
                     this.inventoryData = [
                        { id: 1, name: "EV Battery Pack XT-500", quantity: 5, status: "in-stock" },
                        { id: 2, name: "Charging Cable Type 2", quantity: 3, status: "low-stock" },
                        { id: 3, name: "Brake Pads (EV Specific)", quantity: 12, status: "in-stock" },
                        { id: 4, name: "Tire Repair Kit", quantity: 7, status: "in-stock" }
                    ];
                }

                const storedCustomers = localStorage.getItem('greenpoint_customers');
                if (storedCustomers) {
                    this.customersData = JSON.parse(storedCustomers);
                } else {
                    this.customersData = [
                        { id: 1, name: "John Doe", email: "john.doe@example.com", phone: "555-0101", tags: ["VIP", "Frequent"] },
                        { id: 2, name: "Jane Smith", email: "jane.smith@example.com", phone: "555-0102", tags: ["New"] },
                        { id: 3, name: "Peter Jones", email: "peter.jones@example.com", phone: "555-0103", tags: [] }
                    ];
                }

                const storedServices = localStorage.getItem('greenpoint_services'); // Load services
                if (storedServices) {
                    this.servicesData = JSON.parse(storedServices);
                } else {
                    this.servicesData = [
                        { id: 1, name: "Battery Diagnostics", price: 75.00 },
                        { id: 2, name: "Tire Rotation", price: 50.00 },
                        { id: 3, name: "Software Update", price: 0.00 },
                        { id: 4, name: "Brake System Check", price: 90.00 }
                    ];
                }

                // NEW: Load GreenPoints data
                const storedGreenPoints = localStorage.getItem('greenpoint_loyalty_data');
                if (storedGreenPoints) {
                    this.greenPointsData = JSON.parse(storedGreenPoints);
                } else {
                    this.greenPointsData = [
                        { id: 1, type: 'earned', amount: 500, description: 'Initial Sign-up Bonus', timestamp: new Date().toISOString() },
                        { id: 2, type: 'earned', amount: 100, description: 'Completed Booking #1', timestamp: new Date(Date.now() - 86400000 * 5).toISOString() } // 5 days ago
                    ];
                }

                this.showNotification('Data loaded from local storage.');
            }

            saveDataToLocalStorage() {
                localStorage.setItem('greenpoint_bookings', JSON.stringify(this.bookingsData));
                localStorage.setItem('greenpoint_inventory', JSON.stringify(this.inventoryData));
                localStorage.setItem('greenpoint_customers', JSON.stringify(this.customersData));
                localStorage.setItem('greenpoint_services', JSON.stringify(this.servicesData)); // Save services
                localStorage.setItem('greenpoint_loyalty_data', JSON.stringify(this.greenPointsData)); // NEW: Save GreenPoints data
                this.showNotification('Data saved to local storage.');
            }

            toggleSidebar() {
                const sidebar = document.getElementById('sidebar');
                const content = document.getElementById('content');
                sidebar.classList.toggle('active');
                if (sidebar.classList.contains('active')) {
                    content.style.marginLeft = '220px'; // Adjust for smaller sidebar
                } else {
                    content.style.marginLeft = '0';
                }
            }

            showPage(pageId) {
                document.querySelectorAll('.page').forEach(page => page.style.display = 'none');
                document.getElementById(pageId).style.display = 'block';
                document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
                document.querySelector(`.sidebar a[onclick="showPage('${pageId}')"]`).classList.add('active');
                document.getElementById('page-title').textContent = pageId.charAt(0).toUpperCase() + pageId.slice(1);

                // Hide sidebar on smaller screens when navigating
                if (window.innerWidth <= 768) {
                    document.getElementById('sidebar').classList.remove('active');
                    document.getElementById('content').style.marginLeft = '0';
                }

                // Re-initialize charts and tables when navigating to a page
                if (pageId === 'dashboard') {
                    this.initDashboardCharts();
                    this.updateInventoryTable(this.inventoryData); // Update quick inventory on dashboard
                }
                if (pageId === 'analytics') this.initAnalyticsCharts();
                if (pageId === 'bookings') this.updateBookingsTable(this.bookingsData);
                if (pageId === 'inventory') this.updateInventoryTable(this.inventoryData);
                if (pageId === 'customers') this.updateCustomersTable(this.customersData);
                if (pageId === 'calendar') this.updateCalendar();
                if (pageId === 'greenpoints') this.updateGreenPointsUI(); // NEW: Update GreenPoints UI
                if (pageId === 'settings') {
                    this.loadSettings(); // Load general settings
                    this.updateServicesTable(); // Load and display services
                }
            }

            initDashboardCharts() {
                // Destroy existing chart instances before creating new ones to prevent issues
                if (this.bookingsChartInstance) {
                    this.bookingsChartInstance.destroy();
                }

                const ctx = document.getElementById('bookingsChart').getContext('2d');
                this.bookingsChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                        datasets: [{ label: 'Total Bookings', data: [160, 240, 320, 200, 180, 260], backgroundColor: '#1a3c34' }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
                this.updateDashboardMetrics();
            }

            initAnalyticsCharts() {
                // Destroy existing chart instances
                if (this.monthlyBookingsChartInstance) this.monthlyBookingsChartInstance.destroy();
                if (this.monthlyRevenueChartInstance) this.monthlyRevenueChartInstance.destroy();
                if (this.popularServicesChartInstance) this.popularServicesChartInstance.destroy();

                const ctx1 = document.getElementById('monthlyBookingsChart').getContext('2d');
                this.monthlyBookingsChartInstance = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'],
                        datasets: [{ label: 'Bookings', data: [40, 35, 20, 25, 30, 15, 20], backgroundColor: '#1a3c34' }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
                const ctx2 = document.getElementById('monthlyRevenueChart').getContext('2d');
                this.monthlyRevenueChartInstance = new Chart(ctx2, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'],
                        datasets: [{ label: 'Revenue', data: [2500, 3000, 10000, 7500, 5000, 6000, 7000], borderColor: '#f4a261', fill: false }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
                const ctx3 = document.getElementById('popularServicesChart').getContext('2d');
                this.popularServicesChartInstance = new Chart(ctx3, {
                    type: 'bar',
                    data: {
                        labels: ['Battery Check', 'Tire Rotation', 'Diagnostics', 'Brake Insp.', 'SW Update'],
                        datasets: [{ label: 'Count', data: [70, 60, 40, 30, 20], backgroundColor: '#1a3c34' }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }

            updateDashboardMetrics() {
                document.getElementById('totalBookings').textContent = this.bookingsData.length;
                document.getElementById('completedServices').textContent = this.bookingsData.filter(b => b.status === 'completed').length;
                document.getElementById('pendingServices').textContent = this.bookingsData.filter(b => b.status === 'pending').length;
                document.getElementById('lowStockItems').textContent = this.inventoryData.filter(i => i.status === 'low-stock').length;
            }

            updateBookingsTable(data) {
                const table = document.getElementById('bookingsTable');
                // Clear existing table rows except header
                while (table.rows.length > 1) {
                    table.deleteRow(1);
                }
                data.forEach(booking => {
                    const row = table.insertRow();
                    row.innerHTML = `
                        <td>${booking.id}</td>
                        <td>${booking.customer}</td>
                        <td>${booking.service}</td>
                        <td>${booking.vehicle}</td>
                        <td>${booking.vin}</td>
                        <td>${booking.date}</td>
                        <td><span class="status-${booking.status}">${booking.status.charAt(0).toUpperCase() + booking.status.slice(1)}</span></td>
                        <td class="action-icons">
                            <i class="fas fa-edit" title="Edit" onclick="admin.editBooking(${booking.id})"></i>
                            <i class="fas fa-trash" title="Delete" onclick="admin.deleteBooking(${booking.id})"></i>
                            <i class="fas fa-check-circle" title="Mark as Completed" onclick="admin.markBookingCompleted(${booking.id})"></i>
                        </td>`;
                });
            }

            updateInventoryTable(data) {
                const table = document.getElementById('inventoryTable');
                // Clear existing table rows except header
                while (table.rows.length > 1) {
                    table.deleteRow(1);
                }
                data.forEach(item => {
                    const row = table.insertRow();
                    row.innerHTML = `
                        <td>${item.id}</td>
                        <td>${item.name}</td>
                        <td>${item.quantity}</td>
                        <td><span class="status-${item.status}">${item.status === 'low-stock' ? 'Low Stock' : 'In Stock'}</span></td>
                        <td class="action-icons">
                            <i class="fas fa-edit" title="Edit" onclick="admin.editInventoryItem(${item.id})"></i>
                            <i class="fas fa-trash" title="Delete" onclick="admin.deleteInventoryItem(${item.id})"></i>
                            <i class="fas fa-plus-circle" title="Restock" onclick="admin.restockInventoryItem(${item.id})"></i>
                        </td>`;
                });
            }

            updateCustomersTable(data) {
                const table = document.getElementById('customersTable');
                // Clear existing table rows except header
                while (table.rows.length > 1) {
                    table.deleteRow(1);
                }
                data.forEach(customer => {
                    const row = table.insertRow();
                    row.innerHTML = `
                        <td>${customer.id}</td>
                        <td>${customer.name}</td>
                        <td>${customer.email}</td>
                        <td>${customer.phone}</td>
                        <td>${customer.tags.length ? customer.tags.map(t => `<span class="status-pending">${t}</span>`).join(' ') : 'No tags'}</td>
                        <td class="action-icons">
                            <i class="fas fa-edit" title="Edit" onclick="admin.editCustomer(${customer.id})"></i>
                            <i class="fas fa-trash" title="Delete" onclick="admin.deleteCustomer(${customer.id})"></i>
                            <i class="fas fa-tag" title="Add Tag" onclick="admin.addCustomerTag(${customer.id})"></i>
                        </td>`;
                });
            }

            updateServicesTable() {
                const table = document.getElementById('servicesTable');
                // Clear existing table rows except header
                while (table.rows.length > 1) {
                    table.deleteRow(1);
                }
                this.servicesData.forEach(service => {
                    const row = table.insertRow();
                    row.innerHTML = `
                        <td>${service.id}</td>
                        <td>${service.name}</td>
                        <td>$${service.price.toFixed(2)}</td>
                        <td class="action-icons">
                            <i class="fas fa-edit" title="Edit Service" onclick="admin.editService(${service.id})"></i>
                            <i class="fas fa-trash" title="Delete Service" onclick="admin.deleteService(${service.id})"></i>
                        </td>`;
                });
            }

            updateCalendar() {
                const monthInput = document.getElementById('calendarMonth');
                const [year, monthNum] = (monthInput.value || this.currentDate.toISOString().slice(0, 7)).split('-');
                const selectedDate = new Date(year, parseInt(monthNum) - 1, 1);
                
                const daysInMonth = new Date(year, parseInt(monthNum), 0).getDate();
                const firstDayOfMonth = new Date(year, parseInt(monthNum) - 1, 1).getDay(); // 0 for Sunday, 6 for Saturday

                const table = document.getElementById('calendarTable');
                table.innerHTML = ''; // Clear table
                
                const dayNames = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];
                let headerRow = table.insertRow();
                dayNames.forEach(day => {
                    let th = document.createElement('th');
                    th.textContent = day;
                    headerRow.appendChild(th);
                });

                let row = table.insertRow();
                for (let i = 0; i < firstDayOfMonth; i++) {
                    row.insertCell(); // Empty cells for days before the 1st
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    if (row.cells.length === 7) {
                        row = table.insertRow(); // Start a new week
                    }
                    const cell = row.insertCell();
                    cell.textContent = day;

                    const currentDayString = `${year}-${monthNum.padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                    
                    // Mark current day
                    if (currentDayString === new Date().toISOString().slice(0, 10)) { // Use new Date() for actual current day
                        cell.classList.add('current-day');
                    }

                    // Mark days with bookings
                    if (this.bookingsData.some(b => b.date === currentDayString)) {
                        cell.classList.add('has-booking');
                    }
                     // Add click listener to show bookings for the clicked day
                    cell.onclick = () => this.showBookingsForDay(currentDayString);
                }

                this.showBookingsForDay(new Date().toISOString().slice(0, 10)); // Show bookings for today initially
            }

            showBookingsForDay(dateString) {
                const bookingsForSelectedDay = this.bookingsData.filter(b => b.date === dateString);
                const calendarBookingsDiv = document.getElementById('calendarBookings');
                calendarBookingsDiv.innerHTML = `<h3>Bookings for ${new Date(dateString).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</h3>`;
                if (bookingsForSelectedDay.length) {
                    bookingsForSelectedDay.forEach(b => {
                        calendarBookingsDiv.innerHTML += `<p>${b.customer} - ${b.service} (${b.vehicle}) - <span class="status-${b.status}">${b.status.charAt(0).toUpperCase() + b.status.slice(1)}</span></p>`;
                    });
                } else {
                    calendarBookingsDiv.innerHTML += '<p>No bookings for this day.</p>';
                }
            }


            filterBookings(status) {
                const filteredData = status === 'all' ? this.bookingsData : this.bookingsData.filter(b => b.status === status);
                this.updateBookingsTable(filteredData);
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector(`.tab[onclick="filterBookings('${status}')"]`).classList.add('active');
            }

            searchBookings() {
                const input = document.querySelector('#bookings .search-bar');
                const filter = input.value.toLowerCase();
                const filteredData = this.bookingsData.filter(booking => 
                    booking.customer.toLowerCase().includes(filter) ||
                    booking.service.toLowerCase().includes(filter) ||
                    booking.vehicle.toLowerCase().includes(filter) ||
                    booking.vin.toLowerCase().includes(filter) ||
                    booking.date.includes(filter)
                );
                this.updateBookingsTable(filteredData);
            }

            searchInventory() {
                const input = document.querySelector('#inventory .search-bar');
                const filter = input.value.toLowerCase();
                const filteredData = this.inventoryData.filter(item => 
                    item.name.toLowerCase().includes(filter)
                );
                this.updateInventoryTable(filteredData);
            }

            searchCustomers() {
                const input = document.querySelector('#customers .search-bar');
                const filter = input.value.toLowerCase();
                const filteredData = this.customersData.filter(customer => 
                    customer.name.toLowerCase().includes(filter) ||
                    customer.email.toLowerCase().includes(filter) ||
                    customer.phone.toLowerCase().includes(filter) ||
                    customer.tags.some(tag => tag.toLowerCase().includes(filter))
                );
                this.updateCustomersTable(filteredData);
            }

            // Booking Actions
            editBooking(id) {
                const booking = this.bookingsData.find(b => b.id === id);
                if (booking) {
                    const newCustomer = prompt("Edit Customer Name:", booking.customer);
                    if (newCustomer !== null) {
                        booking.customer = newCustomer;
                        this.saveDataToLocalStorage();
                        this.updateBookingsTable(this.bookingsData);
                        this.showNotification(`Booking ${id} updated.`);
                    }
                }
            }

            deleteBooking(id) {
                if (confirm(`Are you sure you want to delete booking ${id}?`)) {
                    this.bookingsData = this.bookingsData.filter(b => b.id !== id);
                    this.saveDataToLocalStorage();
                    this.updateBookingsTable(this.bookingsData);
                    this.updateDashboardMetrics();
                    this.updateCalendar();
                    this.showNotification(`Booking ${id} deleted.`);
                }
            }

            markBookingCompleted(id) {
                const booking = this.bookingsData.find(b => b.id === id);
                if (booking) {
                    booking.status = 'completed';
                    this.saveDataToLocalStorage();
                    this.updateBookingsTable(this.bookingsData);
                    this.updateDashboardMetrics();
                    // NEW: Earn points for completed booking (example)
                    this.earnPoints(50, `Completed Booking #${id}`);
                    this.showNotification(`Booking ${id} marked as completed.`);
                }
            }

            // Inventory Actions
            editInventoryItem(id) {
                const item = this.inventoryData.find(i => i.id === id);
                if (item) {
                    const newName = prompt("Edit Item Name:", item.name);
                    const newQuantity = prompt("Edit Quantity:", item.quantity);
                    if (newName !== null && newQuantity !== null) {
                        const parsedQuantity = parseInt(newQuantity);
                        if (!isNaN(parsedQuantity) && parsedQuantity >= 0) {
                            item.name = newName;
                            item.quantity = parsedQuantity;
                            item.status = item.quantity < 5 ? 'low-stock' : 'in-stock';
                            this.saveDataToLocalStorage();
                            this.updateInventoryTable(this.inventoryData);
                            this.updateDashboardMetrics();
                            this.showNotification(`Inventory item ${id} updated.`);
                        } else {
                            this.showNotification('Invalid quantity entered. Please enter a non-negative number.');
                        }
                    }
                }
            }

            deleteInventoryItem(id) {
                if (confirm(`Are you sure you want to delete inventory item ${id}?`)) {
                    this.inventoryData = this.inventoryData.filter(i => i.id !== id);
                    this.saveDataToLocalStorage();
                    this.updateInventoryTable(this.inventoryData);
                    this.updateDashboardMetrics();
                    this.showNotification(`Inventory item ${id} deleted.`);
                }
            }

            restockInventoryItem(id) {
                const item = this.inventoryData.find(i => i.id === id);
                if (item) {
                    const restockAmount = parseInt(prompt(`How many items to restock for ${item.name}?`, 10));
                    if (!isNaN(restockAmount) && restockAmount > 0) {
                        item.quantity += restockAmount;
                        item.status = item.quantity < 5 ? 'low-stock' : 'in-stock';
                        this.saveDataToLocalStorage();
                        this.updateInventoryTable(this.inventoryData);
                        this.updateDashboardMetrics();
                        this.showNotification(`${restockAmount} units added to ${item.name}.`);
                    } else if (restockAmount !== null) {
                        this.showNotification('Invalid restock amount. Must be a positive number.');
                    }
                }
            }

            // Customer Actions
            editCustomer(id) {
                const customer = this.customersData.find(c => c.id === id);
                if (customer) {
                    const newName = prompt("Edit Customer Name:", customer.name);
                    const newEmail = prompt("Edit Customer Email:", customer.email);
                    const newPhone = prompt("Edit Customer Phone:", customer.phone);
                    if (newName !== null && newEmail !== null && newPhone !== null) {
                        customer.name = newName;
                        customer.email = newEmail;
                        customer.phone = newPhone;
                        this.saveDataToLocalStorage();
                        this.updateCustomersTable(this.customersData);
                        this.showNotification(`Customer ${id} updated.`);
                    }
                }
            }

            deleteCustomer(id) {
                if (confirm(`Are you sure you want to delete customer ${id}?`)) {
                    this.customersData = this.customersData.filter(c => c.id !== id);
                    this.saveDataToLocalStorage();
                    this.updateCustomersTable(this.customersData);
                    this.showNotification(`Customer ${id} deleted.`);
                }
            }

            addCustomerTag(id) {
                const customer = this.customersData.find(c => c.id === id);
                if (customer) {
                    const newTag = prompt("Add new tag:", "");
                    if (newTag && newTag.trim() !== "") {
                        if (!customer.tags.includes(newTag.trim())) { // Prevent duplicate tags
                            customer.tags.push(newTag.trim());
                            this.saveDataToLocalStorage();
                            this.updateCustomersTable(this.customersData);
                            this.showNotification(`Tag "${newTag.trim()}" added to customer ${id}.`);
                        } else {
                            this.showNotification(`Tag "${newTag.trim()}" already exists for this customer.`);
                        }
                    } else if (newTag !== null) {
                        this.showNotification('Tag cannot be empty.');
                    }
                }
            }
            
            // Service Actions (New)
            showAddServiceForm(serviceId = null) {
                const formDiv = document.getElementById('addServiceForm');
                const serviceForm = document.getElementById('serviceForm');
                serviceForm.reset();
                formDiv.style.display = 'block';
                document.getElementById('serviceName').value = '';
                document.getElementById('servicePrice').value = '';
                serviceForm.dataset.editingId = ''; // Clear editing ID

                if (serviceId !== null) {
                    const service = this.servicesData.find(s => s.id === serviceId);
                    if (service) {
                        document.getElementById('serviceName').value = service.name;
                        document.getElementById('servicePrice').value = service.price;
                        serviceForm.dataset.editingId = service.id; // Set editing ID
                    }
                }
            }

            hideAddServiceForm() {
                document.getElementById('addServiceForm').style.display = 'none';
                document.getElementById('serviceForm').reset();
                document.getElementById('serviceForm').dataset.editingId = ''; // Clear editing ID
            }

            handleServiceForm(e) {
                e.preventDefault();
                const form = document.getElementById('serviceForm');
                const serviceName = form.elements['serviceName'].value;
                const servicePrice = parseFloat(form.elements['servicePrice'].value);
                const editingId = form.dataset.editingId;

                if (isNaN(servicePrice) || servicePrice < 0) {
                    this.showNotification('Please enter a valid positive number for price.');
                    return;
                }

                if (editingId) {
                    // Editing existing service
                    const service = this.servicesData.find(s => s.id === parseInt(editingId));
                    if (service) {
                        service.name = serviceName;
                        service.price = servicePrice;
                        this.showNotification(`Service ${service.id} updated successfully!`);
                    }
                } else {
                    // Adding new service
                    const newService = {
                        id: this.servicesData.length > 0 ? Math.max(...this.servicesData.map(s => s.id)) + 1 : 1,
                        name: serviceName,
                        price: servicePrice
                    };
                    this.servicesData.push(newService);
                    this.showNotification('New service added successfully!');
                }
                this.saveDataToLocalStorage();
                this.updateServicesTable();
                this.hideAddServiceForm();
            }

            editService(id) {
                this.showAddServiceForm(id); // Use the same form for editing
            }

            deleteService(id) {
                if (confirm(`Are you sure you want to delete service ${id}?`)) {
                    this.servicesData = this.servicesData.filter(s => s.id !== id);
                    this.saveDataToLocalStorage();
                    this.updateServicesTable();
                    this.showNotification(`Service ${id} deleted.`);
                }
            }


            showAddBookingForm() {
                document.getElementById('addBookingForm').style.display = 'block';
            }

            hideAddBookingForm() {
                document.getElementById('addBookingForm').style.display = 'none';
                document.getElementById('bookingForm').reset();
            }

            showAddInventoryForm() {
                document.getElementById('addInventoryForm').style.display = 'block';
            }

            hideAddInventoryForm() {
                document.getElementById('addInventoryForm').style.display = 'none';
                document.getElementById('inventoryForm').reset();
            }

            showAddCustomerForm() {
                document.getElementById('addCustomerForm').style.display = 'block';
            }

            hideAddCustomerForm() {
                document.getElementById('addCustomerForm').style.display = 'none';
                document.getElementById('customerForm').reset();
            }

            handleBookingForm(e) {
                e.preventDefault();
                const form = document.getElementById('bookingForm');
                const newBooking = {
                    id: this.bookingsData.length > 0 ? Math.max(...this.bookingsData.map(b => b.id)) + 1 : 1,
                    customer: form.elements['customerName'].value,
                    service: form.elements['service'].value,
                    vehicle: form.elements['vehicle'].value,
                    vin: form.elements['vin'].value,
                    date: form.elements['date'].value,
                    status: 'pending'
                };
                this.bookingsData.push(newBooking);
                this.saveDataToLocalStorage();
                this.updateBookingsTable(this.bookingsData);
                this.updateDashboardMetrics();
                this.updateCalendar(); // Update calendar as a new booking might affect it
                this.hideAddBookingForm();
                this.showNotification('Booking added successfully!');
            }

            handleInventoryForm(e) {
                e.preventDefault();
                const form = document.getElementById('inventoryForm');
                const quantity = parseInt(form.elements['quantity'].value);
                const newItem = {
                    id: this.inventoryData.length > 0 ? Math.max(...this.inventoryData.map(i => i.id)) + 1 : 1,
                    name: form.elements['itemName'].value,
                    quantity: quantity,
                    status: quantity < 5 ? 'low-stock' : 'in-stock'
                };
                this.inventoryData.push(newItem);
                this.saveDataToLocalStorage();
                this.updateInventoryTable(this.inventoryData);
                this.updateDashboardMetrics();
                this.hideAddInventoryForm();
                this.showNotification('Inventory item added successfully!');
            }

            handleCustomerForm(e) {
                e.preventDefault();
                const form = document.getElementById('customerForm');
                const newCustomer = {
                    id: this.customersData.length > 0 ? Math.max(...this.customersData.map(c => c.id)) + 1 : 1,
                    name: form.elements['customerName'].value,
                    email: form.elements['customerEmail'].value,
                    phone: form.elements['customerPhone'].value,
                    tags: form.elements['customerTags'].value.split(',').map(t => t.trim()).filter(t => t !== '')
                };
                this.customersData.push(newCustomer);
                this.saveDataToLocalStorage();
                this.updateCustomersTable(this.customersData);
                this.hideAddCustomerForm();
                this.showNotification('Customer added successfully!');
            }

            async predictDemand() {
                this.showNotification('Generating demand forecast (simulated)...');
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 1500));
                console.log('Simulated demand prediction data.');
                this.showNotification('Demand forecast generated!');
            }

            async optimizeSchedule() {
                this.showNotification('Optimizing schedule (simulated)...');
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 1500));
                console.log('Simulated schedule optimization data.');
                this.showNotification('Schedule optimized!');
            }

            async identifyShortages() {
                this.showNotification('Identifying potential shortages (simulated)...');
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 1500));
                console.log('Simulated shortage identification data.');
                this.showNotification('Inventory shortages identified!');
            }

            previewPhoto() {
                const fileInput = document.getElementById('photoUpload');
                const previewImg = document.getElementById('logoPreview');
                if (fileInput.files && fileInput.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        previewImg.src = e.target.result;
                        this.showNotification('Photo preview updated!');
                    };
                    reader.readAsDataURL(fileInput.files[0]);
                } else {
                    previewImg.src = this.defaultSettings.logoUrl; // Revert to default if no file selected
                    this.showNotification('No photo selected or upload cancelled.');
                }
            }

            saveSettings() {
                const settings = {
                    centerName: document.getElementById('centerName').value,
                    contactEmail: document.getElementById('contactEmail').value,
                    contactPhone: document.getElementById('contactPhone').value,
                    address: document.getElementById('address').value,
                    workingHours: document.getElementById('workingHours').value,
                    defaultServiceDuration: parseInt(document.getElementById('defaultServiceDuration').value),
                    taxRate: parseFloat(document.getElementById('taxRate').value),
                    defaultCurrency: document.getElementById('defaultCurrency').value,
                    emailNotifications: document.getElementById('emailNotifications').checked,
                    smsNotifications: document.getElementById('smsNotifications').checked,
                    logoUrl: document.getElementById('logoPreview').src // Save the current previewed image URL
                };
                // In a real application, you'd send this `settings` object to your backend.
                localStorage.setItem('adminSettings', JSON.stringify(settings)); // Save settings to local storage
                console.log('Settings saved:', settings);
                this.showNotification('Settings saved successfully!');
            }

            loadSettings() {
                // In a real application, fetch settings from backend. For now, use default/dummy.
                const storedSettings = localStorage.getItem('adminSettings');
                let currentSettings = { ...this.defaultSettings }; 
                if (storedSettings) {
                    try {
                        Object.assign(currentSettings, JSON.parse(storedSettings));
                    } catch (e) {
                        console.error("Error parsing stored settings:", e);
                        // Fallback to default settings if parsing fails
                    }
                }

                document.getElementById('centerName').value = currentSettings.centerName;
                document.getElementById('contactEmail').value = currentSettings.contactEmail;
                document.getElementById('contactPhone').value = currentSettings.contactPhone;
                document.getElementById('address').value = currentSettings.address;
                document.getElementById('workingHours').value = currentSettings.workingHours;
                document.getElementById('defaultServiceDuration').value = currentSettings.defaultServiceDuration;
                document.getElementById('taxRate').value = currentSettings.taxRate;
                document.getElementById('defaultCurrency').value = currentSettings.defaultCurrency;
                document.getElementById('emailNotifications').checked = currentSettings.emailNotifications;
                document.getElementById('smsNotifications').checked = currentSettings.smsNotifications;
                document.getElementById('logoPreview').src = currentSettings.logoUrl;
                this.showNotification('Settings loaded.');
            }

            resetSettings() {
                // Reset all settings fields to their default values
                document.getElementById('centerName').value = this.defaultSettings.centerName;
                document.getElementById('contactEmail').value = this.defaultSettings.contactEmail;
                document.getElementById('contactPhone').value = this.defaultSettings.contactPhone;
                document.getElementById('address').value = this.defaultSettings.address;
                document.getElementById('workingHours').value = this.defaultSettings.workingHours;
                document.getElementById('defaultServiceDuration').value = this.defaultSettings.defaultServiceDuration;
                document.getElementById('taxRate').value = this.defaultSettings.taxRate;
                document.getElementById('defaultCurrency').value = this.defaultSettings.defaultCurrency;
                document.getElementById('emailNotifications').checked = this.defaultSettings.emailNotifications;
                document.getElementById('smsNotifications').checked = this.defaultSettings.smsNotifications;
                document.getElementById('logoPreview').src = this.defaultSettings.logoUrl;
                localStorage.removeItem('adminSettings'); // Also remove from local storage
                this.showNotification('Settings reset to defaults.');
            }

            showNotification(message) {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.style.display = 'block';
                setTimeout(() => notification.style.display = 'none', 3000);
            }

            // NEW: GreenPoints Logic
            getCurrentGreenPoints() {
                return this.greenPointsData.reduce((sum, transaction) => {
                    return transaction.type === 'earned' ? sum + transaction.amount : sum - transaction.amount;
                }, 0);
            }

            updateGreenPointsUI() {
                const currentPointsElement = document.getElementById('currentGreenPoints');
                const historyTableBody = document.querySelector('#greenPointsHistoryTable tbody');

                currentPointsElement.textContent = this.getCurrentGreenPoints();
                
                // Clear existing history rows
                historyTableBody.innerHTML = ''; 

                this.greenPointsData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // Sort by newest first

                this.greenPointsData.forEach(transaction => {
                    const row = historyTableBody.insertRow();
                    const date = new Date(transaction.timestamp).toLocaleString();
                    const pointsClass = transaction.type === 'earned' ? 'points-earned' : 'points-spent';
                    const sign = transaction.type === 'earned' ? '+' : '-';
                    row.innerHTML = `
                        <td>${date}</td>
                        <td class="${pointsClass}">${sign}${transaction.amount}</td>
                        <td>${transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1)}</td>
                        <td>${transaction.description}</td>
                    `;
                });
            }

            earnPoints(amount, description) {
                if (amount <= 0) {
                    this.showNotification('Points to earn must be positive.');
                    return;
                }
                const newTransaction = {
                    id: this.greenPointsData.length > 0 ? Math.max(...this.greenPointsData.map(t => t.id)) + 1 : 1,
                    type: 'earned',
                    amount: amount,
                    description: description,
                    timestamp: new Date().toISOString()
                };
                this.greenPointsData.push(newTransaction);
                this.saveDataToLocalStorage();
                this.updateGreenPointsUI();
                this.showNotification(`Earned ${amount} GreenPoints!`);
            }

            spendPoints(amount, description) {
                if (amount <= 0) {
                    this.showNotification('Points to spend must be positive.');
                    return;
                }
                if (this.getCurrentGreenPoints() < amount) {
                    this.showNotification('Not enough GreenPoints to complete this action.');
                    return false;
                }
                const newTransaction = {
                    id: this.greenPointsData.length > 0 ? Math.max(...this.greenPointsData.map(t => t.id)) + 1 : 1,
                    type: 'spent',
                    amount: amount,
                    description: description,
                    timestamp: new Date().toISOString()
                };
                this.greenPointsData.push(newTransaction);
                this.saveDataToLocalStorage();
                this.updateGreenPointsUI();
                this.showNotification(`Spent ${amount} GreenPoints for "${description}"!`);
                return true;
            }

            // Simulated spending actions
            boostVisibility() {
                const pointsCost = 200;
                if (this.spendPoints(pointsCost, 'Boost Listing Visibility')) {
                    console.log('Simulating boosting visibility...');
                    // In a real app, trigger backend API call to boost listing
                }
            }

            getFeatureDiscount() {
                const pointsCost = 150;
                if (this.spendPoints(pointsCost, 'Discount on Premium Features')) {
                    console.log('Simulating applying discount on features...');
                    // In a real app, apply discount or unlock feature
                }
            }
        }

        const admin = new AdminPanel();

        // Event listeners for form submissions
        document.getElementById('bookingForm')?.addEventListener('submit', (e) => admin.handleBookingForm(e));
        document.getElementById('inventoryForm')?.addEventListener('submit', (e) => admin.handleInventoryForm(e));
        document.getElementById('customerForm')?.addEventListener('submit', (e) => admin.handleCustomerForm(e));
        document.getElementById('serviceForm')?.addEventListener('submit', (e) => admin.handleServiceForm(e)); // New event listener for service form

        // Authentication check and initialization
        window.onload = () => {
            // Dummy authentication for demonstration
            localStorage.setItem(auth.tokenKey, 'dummy_token_123');
            localStorage.setItem(auth.roleKey, 'service_center');

            const token = localStorage.getItem(auth.tokenKey);
            const role = localStorage.getItem(auth.roleKey);
            if (!token || role !== 'service_center') {
                alert('Unauthorized access. Please log in as a service center.');
                // In a real application, uncomment the line below to redirect
                // window.location.href = 'index.html';
                return;
            }
            
            admin.showPage('dashboard');
            // Initial population of tables and metrics
            admin.updateDashboardMetrics();
            // calendar month input needs to be set after page is shown and updateCalendar is called
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            document.getElementById('calendarMonth').value = `${year}-${month}`;
            admin.updateCalendar(); // Call again to ensure correct display after setting month

            // Refresh dashboard metrics periodically (e.g., every minute)
            setInterval(() => {
                admin.updateDashboardMetrics();
                console.log('Dashboard metrics refreshed.');
            }, 60000);
        };

        // Expose functions to global scope for event handlers defined in HTML
        window.showPage = (pageId) => admin.showPage(pageId);
        window.toggleSidebar = () => admin.toggleSidebar(); // Expose toggleSidebar
        window.filterBookings = (status) => admin.filterBookings(status);
        window.searchBookings = () => admin.searchBookings();
        window.searchInventory = () => admin.searchInventory();
        window.searchCustomers = () => admin.searchCustomers();
        window.showAddBookingForm = () => admin.showAddBookingForm();
        window.hideAddBookingForm = () => admin.hideAddBookingForm();
        window.showAddInventoryForm = () => admin.showAddInventoryForm();
        window.hideAddInventoryForm = () => admin.hideAddInventoryForm();
        window.showAddCustomerForm = () => admin.showAddCustomerForm();
        window.hideAddCustomerForm = () => admin.hideAddCustomerForm();
        window.predictDemand = () => admin.predictDemand();
        window.optimizeSchedule = () => admin.optimizeSchedule();
        window.identifyShortages = () => admin.identifyShortages();
        window.previewPhoto = () => admin.previewPhoto();
        window.saveSettings = () => admin.saveSettings();
        window.resetSettings = () => admin.resetSettings(); 
        window.updateCalendar = () => admin.updateCalendar(); 
        window.showAddServiceForm = (id) => admin.showAddServiceForm(id); // Expose for adding/editing services
        window.hideAddServiceForm = () => admin.hideAddServiceForm();
        // Expose service actions for table buttons
        window.editService = (id) => admin.editService(id);
        window.deleteService = (id) => admin.deleteService(id);
    </script>
</body>
</html>